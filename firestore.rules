{
  "rules": {
    "databases": [{
      "database": "(default)"
    }],
    "match": "/{database}/documents" {
      // Aturan untuk koleksi 'user'
      "match": "/user/{userId}" {
        // Izin baca: Pengguna bisa membaca data sendiri, admin bisa membaca semua data pengguna.
        "allow read": "if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin');"
        
        // Izin tulis (buat, perbarui):
        // - Admin bisa membuat pengguna baru.
        // - Pengguna bisa memperbarui data mereka sendiri.
        // - Admin bisa memperbarui data pengguna lain.
        "allow write": "if request.auth != null && ((get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin') || request.auth.uid == userId);"

        // Izin hapus: Hanya admin yang bisa menghapus data pengguna.
        "allow delete": "if request.auth != null && get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';"
        
        // Aturan untuk sub-koleksi 'addresses'
        "match": "/addresses/{addressId}" {
           "allow read, write, delete": "if request.auth != null && request.auth.uid == userId;"
        }
      }

      // Aturan untuk koleksi 'products'
      "match": "/products/{productId}" {
        "allow read": "if request.auth != null;"
        "allow write": "if request.auth != null && get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';"
      }

      // Aturan untuk koleksi 'orders'
      "match": "/orders/{orderId}" {
        // Izin baca: Admin ATAU pemilik pesanan.
        "allow read": "if request.auth != null && (get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin' || resource.data.customerId == request.auth.uid);"
        // Izin tulis: Admin ATAU pemilik pesanan.
        "allow write": "if request.auth != null && (get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin' || resource.data.customerId == request.auth.uid);"
         // Izin buat: Semua pengguna terautentikasi bisa membuat pesanan.
        "allow create": "if request.auth != null;"
      }
      
      "match": "/{collection}/{docId}" {
        "allow read, write": "if request.auth != null && get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';"
      }
    }
  }
}