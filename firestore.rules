
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/user/$(userId)).data;
    }

    function isRole(role) {
      return isSignedIn() && getUserData(request.auth.uid).role == role;
    }

    // --- User Profiles ---
    match /user/{userId} {
      // Users can read and update their own profile.
      // Admins can read all user profiles (for staff management, etc.).
      allow read, update: if isUser(userId) || isRole('admin');
      
      // Any signed-in user can create their own user document during registration.
      allow create: if isUser(userId);
    }

    // --- Products ---
    match /products/{productId} {
      // Any signed-in user can read products.
      allow read: if isSignedIn();
      
      // Only admins can create or delete products.
      allow create, delete: if isRole('admin');

      // Admins can update. Resellers can update (needed to decrease stock on checkout).
      allow update: if isRole('admin') || isRole('reseller');
    }

    // --- Orders ---
    match /orders/{orderId} {
      // Admins can read/write all orders.
      allow read, write: if isRole('admin');
      
      // Resellers can create orders for themselves.
      allow create: if isRole('reseller') && isUser(request.resource.data.customerId);
      
      // Resellers can read and update their own orders (e.g., to upload payment proof).
      match /orders/{orderId} {
        allow read, update: if isRole('reseller') && isUser(get(/databases/$(database)/documents/orders/$(orderId)).data.customerId);
      }
    }
    
    // --- Reseller Specific Collections (Addresses) ---
    match /user/{userId}/addresses/{addressId} {
        allow read, write, delete: if isUser(userId);
    }

    // --- Admin-only Collections ---
    match /bank_accounts/{accountId} {
      allow read, write: if isRole('admin');
    }

    match /whatsapp_contacts/{contactId} {
      allow read, write: if isRole('admin');
    }
    
    match /purchase_transactions/{transactionId} {
       allow read, write: if isRole('admin');
    }

    match /stock_adjustments/{adjustmentId} {
       allow read, write: if isRole('admin');
    }
    
    match /operational_expenses/{expenseId} {
        allow read, write: if isRole('admin');
    }
  }
}
