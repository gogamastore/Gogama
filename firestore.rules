rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions (REMOVED)

    // User Collection Rules
    match /user/{userId} {
      // Users can always read their own profile
      allow get: if request.auth.uid == userId;
      // Users can update their own profile data
      allow update: if request.auth.uid == userId;
      // Admins can list and read any user profile (useful for admin panels)
      allow list, read: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
      // Only admins can create or delete user records directly
      allow create, delete: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Products Collection Rules
    match /products/{productId} {
      // Anyone authenticated can view products
      allow read: if request.auth != null;
      // Only admins can create, update, or delete products
      allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Orders Collection Rules
    match /orders/{orderId} {
        // Admins can read and write any order
        allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
        // Resellers can create their own orders
        allow create: if request.auth.uid == request.resource.data.customerId;
        // Resellers can read and update their own orders
        allow get, update: if request.auth.uid == resource.data.customerId;
    }

    // Stock Adjustments Collection (Admin only)
    match /stock_adjustments/{adjustmentId} {
      allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Purchase Transactions Collection (Admin only)
    match /purchase_transactions/{purchaseId} {
       allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Operational Expenses Collection (Admin only)
    match /operational_expenses/{expenseId} {
       allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Bank Accounts Collection (Admin can manage, Resellers can read)
    match /bank_accounts/{accountId} {
        allow read: if request.auth != null;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // WhatsApp Contacts Collection (Admin can manage, Resellers can read)
    match /whatsapp_contacts/{contactId} {
        allow read: if request.auth != null;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Banners Collection (Admin can manage, Resellers can read)
    match /banners/{bannerId} {
       allow read: if request.auth != null;
       allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Promotions Collection (Admin can manage, Resellers can read)
     match /promotions/{promoId} {
       allow read: if request.auth != null;
       allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Trending Products Collection (Admin can manage, Resellers can read)
    match /trending_products/{trendingId} {
        allow read: if request.auth != null;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // User Addresses Subcollection
    match /user/{userId}/addresses/{addressId} {
        // Users can manage their own addresses
        allow read, write, delete: if request.auth.uid == userId;
    }
  }
}
