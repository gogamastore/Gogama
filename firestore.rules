rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Aturan default: Blokir semua akses kecuali yang diizinkan secara eksplisit.
    match /{document=**} {
      allow read, write: if false;
    }

    // Izinkan pengguna membaca profil mereka sendiri dan admin bisa membaca semua.
    // Izinkan pengguna memperbarui data mereka sendiri.
    match /user/{userId} {
      allow read: if request.auth != null; // Semua pengguna terotentikasi bisa membaca profil dasar (jika diperlukan)
      allow write: if request.auth.uid == userId;
    }
    
    // Aturan untuk sub-koleksi alamat
    match /user/{userId}/addresses/{addressId} {
      allow read, write, delete: if request.auth.uid == userId;
    }

    // Aturan Untuk Item Keranjang
    match /user/{userId}/cart/{productId} {
      // Pengguna bisa membaca dan menghapus item keranjangnya sendiri.
      allow read, delete: if request.auth.uid == userId;

      // Saat membuat atau memperbarui item, pastikan datanya valid.
      // Ini mencegah pengguna memasukkan nilai negatif atau data lain yang tidak diinginkan.
      allow create, update: if request.auth.uid == userId
                         && request.resource.data.quantity is number
                         && request.resource.data.quantity > 0
                         && request.resource.data.size() == 1;
    }

    // Aturan untuk produk: Semua bisa membaca, admin bisa menulis.
    match /products/{productId} {
      allow read: if true;
      allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Aturan untuk kategori produk: Semua bisa membaca, admin bisa menulis.
    match /product_categories/{categoryId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk pesanan: Pengguna hanya bisa mengakses pesanan mereka sendiri.
    // Admin bisa mengakses semua pesanan.
    match /orders/{orderId} {
        allow read, update: if request.auth.uid == resource.data.customerId 
                      || get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
        allow create: if request.auth.uid != null;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk rekening bank: Semua bisa membaca, admin bisa menulis.
    match /bank_accounts/{accountId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Aturan untuk kontak WA: Semua bisa membaca, admin bisa menulis.
    match /whatsapp_contacts/{contactId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk banner: Semua bisa membaca, admin bisa menulis.
    match /banners/{bannerId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk promo: Semua bisa membaca, admin bisa menulis.
    match /promotions/{promoId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk produk trending: Semua bisa membaca, admin bisa menulis.
    match /trending_products/{trendingId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk transaksi pembelian & penyesuaian stok
    match /purchase_transactions/{transactionId} {
        allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    match /stock_adjustments/{adjustmentId} {
        allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    match /operational_expenses/{expenseId} {
        allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
    match /suppliers/{supplierId} {
        allow read, write: if get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }
  }
}