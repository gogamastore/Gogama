rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      // Check if the user is an admin by looking at their role in the 'user' collection.
      return request.auth != null && get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role == 'admin';
    }

    match /user/{userId} {
      allow read: if request.auth != null; // Allow any authenticated user to read user data (needed for isAdmin and other functions)
      allow write: if request.auth.uid == userId || isAdmin(); // Allow user to update their own data, or admin to update any
      
      match /addresses/{addressId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    match /products/{productId} {
      allow read: if true; // Everyone can see products
      allow write: if isAdmin(); // Only admins can create/update/delete products
    }
    
    match /stock_adjustments/{adjustmentId} {
        allow write: if isAdmin(); // Only admins can create stock adjustments
    }

    match /orders/{orderId} {
      allow read: if request.auth.uid == resource.data.customerId || isAdmin();
      allow create: if request.auth.uid != null; // Any authenticated user can create an order
      allow update: if isAdmin() || request.auth.uid == resource.data.customerId; // Admin can update, or user can update their own (e.g., upload proof)
    }

    match /purchase_transactions/{transactionId} {
        allow read, write: if isAdmin();
    }
    
    match /operational_expenses/{expenseId} {
        allow read, write: if isAdmin();
    }

    match /bank_accounts/{accountId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    match /whatsapp_contacts/{contactId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    match /banners/{bannerId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    match /promotions/{promoId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
  }
}
